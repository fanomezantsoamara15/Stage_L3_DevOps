name: CI/CD Pipeline for Quiz Connect App

on:
  push:
    branches:
      - main

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Backend Image
        run: docker build -t delph152/quiz-connect-backend:latest -f backend/Dockerfile .

      - name: Build Frontend Image (uses config.json at runtime)
        run: docker build -t delph152/quiz-connect-frontend:latest ./quiz-connect-forge

      - name: Push Backend Image
        run: docker push delph152/quiz-connect-backend:latest

      - name: Push Frontend Image
        run: docker push delph152/quiz-connect-frontend:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    if: success()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      # Si ton secret est YAML brut (non base64)
      - name: Configure kubeconfig
        run: |
          mkdir -p "$HOME/.kube"
          printf "%s" "${{ secrets.KUBECONFIG }}" > "$HOME/.kube/config"
          chmod 600 "$HOME/.kube/config"
          echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV

      # Si ton secret est en base64, utilise ce bloc Ã  la place:
      # - name: Configure kubeconfig (base64)
      #   env:
      #     KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}
      #   run: |
      #     mkdir -p "$HOME/.kube"
      #     echo "$KUBECONFIG_B64" | base64 -d > "$HOME/.kube/config"
      #     chmod 600 "$HOME/.kube/config"
      #     echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV

      - name: Ensure namespace exists
        run: kubectl get ns quiz-connect || kubectl create ns quiz-connect

      - name: Apply ConfigMap
        run: kubectl apply -f k8s/frontend-configmap.yaml -n quiz-connect

      - name: Apply Deployments
        run: kubectl apply -f k8s/ -n quiz-connect

      - name: Rollout Restart
        run: kubectl rollout restart deployment frontend -n quiz-connect