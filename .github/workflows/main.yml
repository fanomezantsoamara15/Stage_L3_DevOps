# name: CI/CD Pipeline for Quiz Connect  App

# on:
#   push:
#     branches:
#       - main # Exécute le workflow quand il y a un push sur la branche main

# jobs:
#   build_and_push:
#     runs-on: ubuntu-latest # Environnement d'exécution

#     steps:
#       - name: Checkout Code
#         uses: actions/checkout@v4 # Updated to latest version for better security

#       - name: Build Backend Docker Image
#         run: docker build -t delph152/quiz-connect-backend:latest -f backend/Dockerfile .
#         # Build du backend Python/Flask depuis le dossier backend/

#       - name: Build Frontend Docker Image
#         run: docker build -t delph152/quiz-connect-frontend:latest ./quiz-connect-forge
#         # Build du frontend React/TypeScript depuis le dossier quiz-connect-forge

#       - name: Log in to Docker Hub
#         uses: docker/login-action@v3 # Updated to latest version
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}
#         # Tu devras configurer ces secrets dans les paramètres de ton dépôt GitHub

#       - name: Push Backend Docker Image
#         run: docker push delph152/quiz-connect-backend:latest

#       - name: Push Frontend Docker Image
#         run: docker push delph152/quiz-connect-frontend:latest

#   deploy:
#     runs-on: ubuntu-latest
#     needs: build_and_push # Dépend de la réussite de l'étape de build
#     environment: production # Définit l'environnement de déploiement
#     if: success() # Ne s'exécute que si l'étape précédente a réussi

#     steps:
#       - name: Deploy to Server (Placeholder)
#         run: |
#           echo "Simulating deployment to a production server..."
#           echo "In a real scenario, this would involve SSHing into your server,"
#           echo "pulling the new Docker images, and restarting your containers."
#           echo "Example (simplifié):"
#           echo "  ssh -i ~/.ssh/your_key user@your_server_ip 'docker pull delph152/quiz-connect-backend:latest && docker pull delph152/quiz-connect-frontend:latest && docker compose -f /path/to/remote/docker-compose.yml up -d --force-recreate'"
#           echo "Deployment completed for delph152/quiz-connect-backend:latest and delph152/quiz-connect-frontend:latest"

name: CI/CD Pipeline for Quiz Connect App

on:
  push:
    branches:
      - main

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: delph152/quiz-connect-backend:latest

      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./quiz-connect-forge
          push: true
          tags: delph152/quiz-connect-frontend:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > ~/.kube/config
        # Tu devras copier le contenu de ton fichier .yml fourni par OVH dans ce secret GitHub

      - name: Deploy to Kubernetes (OVHcloud)
        run: |
          # Applique les changements (ConfigMaps, Secrets, PVC)
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/
          
          # Force le redémarrage des Pods pour qu'ils téléchargent la nouvelle image :latest
          kubectl rollout restart deployment/backend -n quiz-connect
          kubectl rollout restart deployment/frontend -n quiz-connect