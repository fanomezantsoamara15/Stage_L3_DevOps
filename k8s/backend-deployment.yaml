apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: quiz-connect
  labels:
    app: backend
    tier: backend

spec:
  replicas: 1
  revisionHistoryLimit: 3

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: backend

  template:
    metadata:
      labels:
        app: backend
        tier: backend

    spec:
      terminationGracePeriodSeconds: 20

      tolerations:
        - key: "node.cloudprovider.kubernetes.io/uninitialized"
          operator: "Equal"
          value: "true"
          effect: "NoSchedule"

      containers:
      - name: backend
        image: delph152/quiz-connect-backend:latest
        imagePullPolicy: Always

        ports:
          - containerPort: 5000

        # ===== Ressources =====
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"

        # ===== Probes =====

        startupProbe:
          httpGet:
            path: /health
            port: 5000
          failureThreshold: 30
          periodSeconds: 5

        readinessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 20
          periodSeconds: 10
          timeoutSeconds: 2
          failureThreshold: 3

        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 10
          periodSeconds: 20
          timeoutSeconds: 2
          failureThreshold: 5

        # ===== Variables =====
        env:
          - name: FLASK_APP
            value: main.py
          - name: FLASK_ENV
            value: production

          - name: MYSQL_HOST
            value: mysql
          - name: MYSQL_USER
            value: root
          - name: MYSQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: mysql-secret
                key: root-password
          - name: MYSQL_DATABASE
            value: quiz_connect

          - name: SECRET_KEY
            value: votre_cle_secrete_ici
          - name: MAIL_SERVER
            value: smtp.sendgrid.net

          - name: MAIL_PORT
            value: "587"

          - name: MAIL_USERNAME
            value: apikey

          - name: MAIL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: sendgrid-secret
                key: MAIL_PASSWORD

          - name: MAIL_DEFAULT_SENDER
            value: fanomezantsoamara@gmail.com

          
          
        # ===== Uploads persistants =====
        volumeMounts:
          - name: uploads
            mountPath: /app/uploads

      # ===== Volume PVC =====
      volumes:
        - name: uploads
          persistentVolumeClaim:
            claimName: uploads-pvc
